<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SmartVillage ‚Äî IoT Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#f5f5f7;--card:#fff;--text-primary:#1d1d1f;--text-secondary:#86868b;
            --text-tertiary:#aeaeb2;--accent-blue:#007aff;--accent-green:#34c759;
            --accent-orange:#ff9500;--accent-red:#ff3b30;--accent-purple:#af52de;
            --accent-teal:#5ac8fa;--accent-indigo:#5856d6;--accent-yellow:#ffcc00;
            --border:rgba(0,0,0,0.06);
            --shadow-sm:0 1px 3px rgba(0,0,0,0.04),0 1px 2px rgba(0,0,0,0.06);
            --shadow-md:0 4px 14px rgba(0,0,0,0.06),0 2px 6px rgba(0,0,0,0.04);
            --shadow-lg:0 10px 40px rgba(0,0,0,0.08),0 4px 12px rgba(0,0,0,0.04);
            --shadow-xl:0 20px 60px rgba(0,0,0,0.1),0 8px 20px rgba(0,0,0,0.06);
            --radius:16px;--radius-sm:12px;--radius-xs:8px;
            --transition:0.3s cubic-bezier(.25,.46,.45,.94);
            --spring:0.5s cubic-bezier(.34,1.56,.64,1);
        }
        body{font-family:'Inter',-apple-system,BlinkMacSystemFont,sans-serif;background:var(--bg);color:var(--text-primary);overflow-x:hidden;-webkit-font-smoothing:antialiased}
        .bg-blobs{position:fixed;inset:0;z-index:0;overflow:hidden;pointer-events:none}
        .blob{position:absolute;border-radius:50%;filter:blur(80px);opacity:.35;animation:blobFloat 20s ease-in-out infinite}
        .blob-1{width:500px;height:500px;background:linear-gradient(135deg,#007aff33,#5ac8fa33);top:-10%;right:-5%}
        .blob-2{width:400px;height:400px;background:linear-gradient(135deg,#34c75933,#ffcc0033);bottom:-10%;left:-5%;animation-delay:-7s}
        .blob-3{width:300px;height:300px;background:linear-gradient(135deg,#af52de33,#ff950033);top:40%;left:30%;animation-delay:-14s}
        @keyframes blobFloat{0%,100%{transform:translate(0,0) scale(1)}25%{transform:translate(50px,-30px) scale(1.1)}50%{transform:translate(-20px,40px) scale(.95)}75%{transform:translate(30px,20px) scale(1.05)}}
        .app{position:relative;z-index:1;display:flex;min-height:100vh}

        .sidebar{width:260px;background:rgba(255,255,255,.72);backdrop-filter:blur(40px) saturate(180%);border-right:1px solid var(--border);padding:28px 16px;display:flex;flex-direction:column;position:fixed;top:0;left:0;bottom:0;z-index:100;transition:transform var(--transition)}
        .sidebar-brand{display:flex;align-items:center;gap:12px;padding:4px 12px 24px;border-bottom:1px solid var(--border);margin-bottom:20px}
        .brand-icon{width:40px;height:40px;border-radius:10px;background:linear-gradient(135deg,var(--accent-blue),var(--accent-indigo));display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .brand-icon svg{width:22px;height:22px;fill:#fff}
        .brand-text h1{font-size:17px;font-weight:700;letter-spacing:-.3px}
        .brand-text span{font-size:11px;color:var(--text-secondary);font-weight:500}
        .nav-section{margin-bottom:24px}
        .nav-label{font-size:11px;font-weight:600;color:var(--text-tertiary);text-transform:uppercase;letter-spacing:.8px;padding:0 12px;margin-bottom:6px}
        .nav-item{display:flex;align-items:center;gap:10px;padding:10px 12px;border-radius:var(--radius-xs);cursor:pointer;transition:all var(--transition);font-size:14px;font-weight:500;color:var(--text-secondary);user-select:none}
        .nav-item:hover{background:rgba(0,0,0,.04);color:var(--text-primary)}
        .nav-item.active{background:var(--accent-blue);color:#fff;box-shadow:0 2px 8px rgba(0,122,255,.3)}
        .nav-item.active svg{fill:#fff}
        .nav-item svg{width:18px;height:18px;fill:currentColor;flex-shrink:0}
        .nav-badge{margin-left:auto;background:var(--accent-red);color:#fff;font-size:11px;font-weight:600;padding:2px 7px;border-radius:10px;min-width:20px;text-align:center}
        .nav-item.active .nav-badge{background:rgba(255,255,255,.3)}
        .sidebar-footer{margin-top:auto;padding:16px 12px;border-top:1px solid var(--border)}
        .user-info{display:flex;align-items:center;gap:10px}
        .user-avatar{width:36px;height:36px;border-radius:50%;background:linear-gradient(135deg,var(--accent-orange),var(--accent-red));display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;color:#fff}
        .user-details h4{font-size:13px;font-weight:600}
        .user-details span{font-size:11px;color:var(--text-secondary)}

        .main{flex:1;margin-left:260px;padding:28px 32px;max-width:calc(100vw - 260px)}
        .header{display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:12px}
        .header-left h2{font-size:28px;font-weight:700;letter-spacing:-.5px}
        .header-left p{font-size:14px;color:var(--text-secondary);margin-top:4px}
        .header-right{display:flex;align-items:center;gap:12px}
        .header-btn{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--card);display:flex;align-items:center;justify-content:center;cursor:pointer;transition:all var(--transition);position:relative}
        .header-btn:hover{transform:scale(1.05);box-shadow:var(--shadow-md)}
        .header-btn svg{width:18px;height:18px;fill:var(--text-secondary)}
        .notif-dot{position:absolute;top:8px;right:8px;width:8px;height:8px;background:var(--accent-red);border-radius:50%;border:2px solid var(--card);display:none}
        .notif-dot.show{display:block}
        .menu-toggle{display:none;width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--card);align-items:center;justify-content:center;cursor:pointer}
        .menu-toggle svg{width:18px;height:18px;fill:var(--text-primary)}
        .live-indicator{display:inline-flex;align-items:center;gap:6px;font-size:11px;color:var(--accent-red);font-weight:600}
        .live-dot{width:6px;height:6px;background:var(--accent-red);border-radius:50%;animation:pulse 1s ease-in-out infinite}
        .conn-indicator{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:12px;font-size:11px;font-weight:600}
        .conn-indicator.online{background:rgba(52,199,89,.1);color:var(--accent-green)}
        .conn-indicator.offline{background:rgba(255,59,48,.1);color:var(--accent-red)}
        .conn-indicator.partial{background:rgba(255,149,0,.1);color:var(--accent-orange)}

        .status-bar{display:flex;align-items:center;gap:8px;padding:12px 16px;border-radius:var(--radius-sm);margin-bottom:24px;border:1px solid rgba(52,199,89,.15);animation:slideDown .6s ease-out;background:linear-gradient(135deg,#e8f5e9,#f1f8e9)}
        @keyframes slideDown{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:translateY(0)}}
        .status-dot{width:8px;height:8px;background:var(--accent-green);border-radius:50%;animation:pulse 2s ease-in-out infinite}
        @keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.3)}}
        .status-bar span{font-size:13px;font-weight:500;color:#2d6a2e}
        .status-bar .status-time{margin-left:auto;font-size:12px;color:#4a8c4b}

        .gps-bar{display:none;align-items:center;gap:12px;padding:10px 16px;background:rgba(0,122,255,.06);border-radius:var(--radius-xs);margin-bottom:12px;border:1px solid rgba(0,122,255,.1)}
        .gps-bar.show{display:flex}
        .gps-bar .gps-text{font-size:12px;color:var(--accent-blue);font-weight:500}
        .gps-bar .gps-coords{font-family:'SF Mono','Fira Code',monospace;font-size:12px;color:var(--text-primary);font-weight:600;margin-left:auto}

        .stats-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:16px;margin-bottom:24px}
        .stat-card{background:var(--card);border-radius:var(--radius);padding:20px;border:1px solid var(--border);transition:all var(--transition);cursor:default;animation:cardAppear .6s ease-out both;position:relative;overflow:hidden}
        .stat-card::before{content:'';position:absolute;top:0;left:0;right:0;height:3px;border-radius:3px 3px 0 0;opacity:0;transition:opacity var(--transition)}
        .stat-card:hover::before{opacity:1}
        .stat-card:nth-child(1)::before{background:var(--accent-red)}
        .stat-card:nth-child(2)::before{background:var(--accent-green)}
        .stat-card:nth-child(3)::before{background:var(--accent-blue)}
        .stat-card:nth-child(4)::before{background:var(--accent-orange)}
        .stat-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
        @keyframes cardAppear{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
        .stat-card:nth-child(1){animation-delay:.05s}.stat-card:nth-child(2){animation-delay:.1s}.stat-card:nth-child(3){animation-delay:.15s}.stat-card:nth-child(4){animation-delay:.2s}
        .stat-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
        .stat-icon{width:40px;height:40px;border-radius:var(--radius-xs);display:flex;align-items:center;justify-content:center}
        .stat-icon svg{width:20px;height:20px;fill:#fff}
        .stat-icon.red{background:linear-gradient(135deg,#ff3b30,#ff6259)}
        .stat-icon.green{background:linear-gradient(135deg,#34c759,#5dd97c)}
        .stat-icon.blue{background:linear-gradient(135deg,#007aff,#409cff)}
        .stat-icon.orange{background:linear-gradient(135deg,#ff9500,#ffb340)}
        .stat-trend{font-size:12px;font-weight:600;padding:3px 8px;border-radius:20px}
        .stat-trend.up{color:var(--accent-red);background:rgba(255,59,48,.1)}
        .stat-trend.down{color:var(--accent-green);background:rgba(52,199,89,.1)}
        .stat-value{font-size:32px;font-weight:800;letter-spacing:-1px;line-height:1;margin-bottom:4px}
        .stat-label{font-size:13px;color:var(--text-secondary);font-weight:500}
        .stat-sub{font-size:11px;color:var(--text-tertiary);margin-top:4px}
        .sparkline-container{display:flex;align-items:flex-end;gap:2px;height:30px;margin-top:8px}
        .sparkline-bar{width:4px;border-radius:2px;background:var(--accent-blue);transition:height .3s ease;min-height:2px}

        .content-grid{display:grid;grid-template-columns:1fr 1fr;gap:16px;margin-bottom:24px}
        .card{background:var(--card);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;animation:cardAppear .6s ease-out both}
        .card-header{display:flex;align-items:center;justify-content:space-between;padding:18px 20px 14px}
        .card-header h3{font-size:16px;font-weight:700;letter-spacing:-.2px}
        .card-header-action{font-size:13px;color:var(--accent-blue);cursor:pointer;font-weight:600;transition:opacity var(--transition)}
        .card-header-action:hover{opacity:.7}
        .card-body{padding:0 20px 20px}

        .map-container{width:100%;height:380px;border-radius:var(--radius-sm);overflow:hidden;position:relative}
        .map-controls-bar{display:flex;gap:8px;margin-top:12px;flex-wrap:wrap}
        .map-ctrl-btn{padding:6px 14px;border-radius:20px;border:1px solid var(--border);background:var(--card);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all var(--transition);display:flex;align-items:center;gap:6px}
        .map-ctrl-btn:hover{background:var(--accent-blue);color:#fff;border-color:var(--accent-blue)}
        .map-legend{display:flex;gap:14px;margin-top:14px;flex-wrap:wrap}
        .legend-item{display:flex;align-items:center;gap:6px;font-size:12px;color:var(--text-secondary);font-weight:500}
        .legend-dot{width:8px;height:8px;border-radius:50%}

        .pothole-list{display:flex;flex-direction:column;gap:10px;max-height:460px;overflow-y:auto}
        .pothole-list::-webkit-scrollbar{width:4px}
        .pothole-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
        .pothole-item{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:var(--radius-xs);background:var(--bg);transition:all var(--transition);cursor:pointer}
        .pothole-item:hover{background:rgba(0,0,0,.04);transform:translateX(4px)}
        .pothole-severity{width:10px;height:10px;border-radius:50%;flex-shrink:0}
        .pothole-severity.critical{background:var(--accent-red)}
        .pothole-severity.warning{background:var(--accent-orange)}
        .pothole-severity.minor{background:var(--accent-yellow)}
        .pothole-info{flex:1;min-width:0}
        .pothole-info h4{font-size:13px;font-weight:600;margin-bottom:2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
        .pothole-info span{font-size:11px;color:var(--text-secondary)}
        .pothole-status{font-size:11px;font-weight:600;padding:4px 10px;border-radius:20px;white-space:nowrap;flex-shrink:0}
        .pothole-status.pending{color:var(--accent-orange);background:rgba(255,149,0,.1)}
        .pothole-status.resolved{color:var(--accent-green);background:rgba(52,199,89,.1)}

        .devices-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        .device-card{padding:16px;border-radius:var(--radius-sm);background:var(--bg);transition:all var(--transition);cursor:pointer}
        .device-card:hover{background:rgba(0,0,0,.04);transform:translateY(-1px)}
        .device-card-header{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:14px}
        .device-icon-wrap{width:44px;height:44px;border-radius:var(--radius-xs);display:flex;align-items:center;justify-content:center}
        .device-icon-wrap svg{width:22px;height:22px;fill:#fff}
        .toggle{width:48px;height:28px;border-radius:14px;background:#d1d1d6;cursor:pointer;transition:background var(--transition);position:relative;flex-shrink:0}
        .toggle.on{background:var(--accent-green)}
        .toggle.sending{background:var(--accent-orange);animation:togglePulse 1s infinite}
        @keyframes togglePulse{0%,100%{opacity:1}50%{opacity:.6}}
        .toggle-knob{position:absolute;top:2px;left:2px;width:24px;height:24px;border-radius:50%;background:#fff;box-shadow:0 1px 3px rgba(0,0,0,.15);transition:transform var(--spring)}
        .toggle.on .toggle-knob{transform:translateX(20px)}
        .device-name{font-size:14px;font-weight:600;margin-bottom:2px}
        .device-status{font-size:12px;color:var(--text-secondary)}

        .full-grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;margin-bottom:24px}
        .alerts-list{display:flex;flex-direction:column;gap:8px;max-height:350px;overflow-y:auto}
        .alerts-list::-webkit-scrollbar{width:4px}
        .alerts-list::-webkit-scrollbar-thumb{background:var(--border);border-radius:4px}
        .alert-item{display:flex;align-items:flex-start;gap:10px;padding:12px;border-radius:var(--radius-xs);transition:all var(--transition);cursor:pointer}
        .alert-item:hover{background:var(--bg)}
        .alert-dot{width:8px;height:8px;border-radius:50%;margin-top:5px;flex-shrink:0}
        .alert-dot.red{background:var(--accent-red)}.alert-dot.orange{background:var(--accent-orange)}.alert-dot.blue{background:var(--accent-blue)}.alert-dot.green{background:var(--accent-green)}
        .alert-content h4{font-size:13px;font-weight:600;margin-bottom:2px}
        .alert-content p{font-size:12px;color:var(--text-secondary);line-height:1.4}
        .alert-time{font-size:11px;color:var(--text-tertiary);margin-left:auto;white-space:nowrap;flex-shrink:0}

        .controls-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:16px;margin-bottom:24px}
        .gauge-container{display:flex;flex-direction:column;align-items:center;padding-top:8px}
        .gauge-svg{width:140px;height:140px;transform:rotate(-90deg)}
        .gauge-bg{fill:none;stroke:rgba(0,0,0,.06);stroke-width:10}
        .gauge-fill{fill:none;stroke-width:10;stroke-linecap:round;transition:stroke-dashoffset 1.5s ease-out}
        .gauge-text{text-anchor:middle;font-family:'Inter',sans-serif;transform:rotate(90deg);transform-origin:center}
        .gauge-value{font-size:24px;font-weight:800;fill:var(--text-primary)}
        .gauge-unit{font-size:11px;fill:var(--text-secondary);font-weight:500}
        .gauge-label{margin-top:10px;font-size:14px;font-weight:600;text-align:center}
        .gauge-sublabel{font-size:12px;color:var(--text-secondary);margin-top:2px}

        .quick-actions{display:flex;flex-direction:column;gap:8px}
        .action-btn{display:flex;align-items:center;gap:10px;padding:12px 14px;border-radius:var(--radius-xs);border:none;background:var(--bg);cursor:pointer;font-family:inherit;font-size:13px;font-weight:600;color:var(--text-primary);transition:all var(--transition);text-align:left}
        .action-btn:hover{background:rgba(0,0,0,.06);transform:translateX(4px)}
        .action-btn:active{transform:translateX(2px) scale(.98)}
        .action-btn svg{width:18px;height:18px;flex-shrink:0}
        .action-btn .action-arrow{margin-left:auto;width:16px;height:16px;fill:var(--text-tertiary)}

        .progress-bar{width:100%;height:6px;border-radius:3px;background:rgba(0,0,0,.08);overflow:hidden}
        .progress-fill{height:100%;border-radius:3px;transition:width 1s ease-out}
        .progress-fill.green{background:linear-gradient(90deg,#34c759,#5dd97c)}
        .progress-fill.orange{background:linear-gradient(90deg,#ff9500,#ffb340)}
        .progress-fill.red{background:linear-gradient(90deg,#ff3b30,#ff6259)}

        .command-log{max-height:200px;overflow-y:auto;font-family:'SF Mono','Fira Code',monospace;font-size:11px;background:#1d1d1f;color:#34c759;padding:12px;border-radius:var(--radius-xs);margin-top:12px}
        .command-log::-webkit-scrollbar{width:4px}
        .command-log::-webkit-scrollbar-thumb{background:#333;border-radius:4px}
        .cmd-line{padding:2px 0;opacity:.8}.cmd-line:last-child{opacity:1}
        .cmd-time{color:#86868b}.cmd-success{color:#34c759}.cmd-error{color:#ff3b30}.cmd-info{color:#5ac8fa}

        .modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.4);backdrop-filter:blur(10px);z-index:1000;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease}
        .modal-overlay.show{opacity:1;pointer-events:all}
        .modal{background:var(--card);border-radius:20px;padding:32px;width:90%;max-width:520px;box-shadow:var(--shadow-xl);transform:scale(.9) translateY(20px);transition:transform var(--spring);max-height:90vh;overflow-y:auto}
        .modal-overlay.show .modal{transform:scale(1) translateY(0)}
        .modal h3{font-size:20px;font-weight:700;margin-bottom:6px}
        .modal p{font-size:14px;color:var(--text-secondary);margin-bottom:24px}
        .form-group{margin-bottom:16px}
        .form-group label{display:block;font-size:13px;font-weight:600;margin-bottom:6px}
        .form-input{width:100%;padding:10px 14px;border-radius:var(--radius-xs);border:1px solid var(--border);background:var(--bg);font-family:inherit;font-size:14px;color:var(--text-primary);outline:none;transition:all var(--transition)}
        .form-input:focus{border-color:var(--accent-blue);box-shadow:0 0 0 3px rgba(0,122,255,.15)}
        .form-row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        select.form-input{appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='%2386868b'%3E%3Cpath d='M7 10l5 5 5-5z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:32px}
        textarea.form-input{resize:vertical;min-height:80px}
        .modal-actions{display:flex;gap:10px;margin-top:24px}
        .btn{padding:10px 20px;border-radius:var(--radius-xs);border:none;font-family:inherit;font-size:14px;font-weight:600;cursor:pointer;transition:all var(--transition);flex:1}
        .btn:active{transform:scale(.97)}
        .btn-primary{background:var(--accent-blue);color:#fff}
        .btn-primary:hover{background:#0071e3}
        .btn-primary:disabled{opacity:.5;pointer-events:none}
        .btn-secondary{background:var(--bg);color:var(--text-primary)}
        .modal-map-container{width:100%;height:200px;border-radius:var(--radius-sm);overflow:hidden;margin-top:8px;border:1px solid var(--border)}
        .map-pick-btn{display:inline-flex;align-items:center;gap:6px;padding:6px 12px;border-radius:var(--radius-xs);border:1px dashed var(--accent-blue);background:rgba(0,122,255,.04);color:var(--accent-blue);font-size:12px;font-weight:600;cursor:pointer;transition:all var(--transition);margin-top:6px}
        .map-pick-btn:hover{background:rgba(0,122,255,.1)}

        .toast-container{position:fixed;top:24px;right:24px;z-index:2000;display:flex;flex-direction:column;gap:8px}
        .toast{background:var(--card);border-radius:var(--radius-sm);padding:14px 20px;box-shadow:var(--shadow-xl);display:flex;align-items:center;gap:12px;transform:translateX(120%);transition:transform var(--spring);max-width:360px;border:1px solid var(--border)}
        .toast.show{transform:translateX(0)}
        .toast-icon{width:32px;height:32px;border-radius:50%;display:flex;align-items:center;justify-content:center;flex-shrink:0}
        .toast-icon svg{width:16px;height:16px;fill:#fff}
        .toast-icon.success{background:var(--accent-green)}.toast-icon.error{background:var(--accent-red)}.toast-icon.info{background:var(--accent-blue)}.toast-icon.warning{background:var(--accent-orange)}
        .toast-text h4{font-size:13px;font-weight:600}
        .toast-text p{font-size:12px;color:var(--text-secondary)}
        .toast-close{background:none;border:none;cursor:pointer;padding:4px;margin-left:8px;opacity:.5;transition:opacity var(--transition)}
        .toast-close:hover{opacity:1}
        .toast-close svg{width:14px;height:14px;fill:var(--text-secondary)}

        .page{display:none;animation:fadeIn .4s ease-out}
        .page.active{display:block}
        @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
        .sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(0,0,0,.3);z-index:99}
        .sidebar-overlay.show{display:block}

        .water-tank{width:100%;height:120px;background:#e3f2fd;border-radius:8px;position:relative;overflow:hidden;border:2px solid #90caf9}
        .water-tank-fill{position:absolute;bottom:0;left:0;right:0;background:linear-gradient(180deg,#42a5f5,#1565c0);transition:height 1s ease;border-radius:0 0 6px 6px}
        .water-tank-text{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-size:18px;font-weight:700;color:#1565c0;z-index:1}

        /* GPIO Control Cards */
        .gpio-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:12px}
        .gpio-card{padding:16px;border-radius:var(--radius-sm);background:var(--bg);border:1px solid var(--border);transition:all var(--transition)}
        .gpio-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px)}
        .gpio-card-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
        .gpio-pin-badge{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:6px;font-size:11px;font-weight:700;font-family:'SF Mono','Fira Code',monospace}
        .gpio-pin-badge.esp1{background:rgba(0,122,255,.1);color:var(--accent-blue)}
        .gpio-pin-badge.esp2{background:rgba(52,199,89,.1);color:var(--accent-green)}
        .gpio-name{font-size:14px;font-weight:600;margin-bottom:2px}
        .gpio-desc{font-size:11px;color:var(--text-secondary);margin-bottom:10px}
        .gpio-status{display:flex;align-items:center;justify-content:space-between}
        .gpio-state{font-size:12px;font-weight:600;padding:3px 10px;border-radius:12px}
        .gpio-state.on{background:rgba(52,199,89,.12);color:var(--accent-green)}
        .gpio-state.off{background:rgba(0,0,0,.04);color:var(--text-tertiary)}
        .gpio-indicator{width:10px;height:10px;border-radius:50%;transition:all var(--transition)}
        .gpio-indicator.on{background:var(--accent-green);box-shadow:0 0 8px rgba(52,199,89,.5)}
        .gpio-indicator.off{background:#d1d1d6}
        .gpio-indicator.pulse{animation:gpioPulse 1s infinite}
        @keyframes gpioPulse{0%,100%{box-shadow:0 0 4px rgba(52,199,89,.3)}50%{box-shadow:0 0 16px rgba(52,199,89,.8)}}

        .esp-section{margin-bottom:24px}
        .esp-section-title{display:flex;align-items:center;gap:10px;margin-bottom:16px;padding-bottom:10px;border-bottom:1px solid var(--border)}
        .esp-section-title h4{font-size:15px;font-weight:700}
        .esp-section-title .esp-tag{padding:3px 10px;border-radius:8px;font-size:11px;font-weight:700}
        .esp-tag.blue{background:rgba(0,122,255,.1);color:var(--accent-blue)}
        .esp-tag.green{background:rgba(52,199,89,.1);color:var(--accent-green)}

        .bulk-actions{display:flex;gap:8px;margin-bottom:16px;flex-wrap:wrap}
        .bulk-btn{padding:8px 16px;border-radius:20px;border:1px solid var(--border);background:var(--card);font-family:inherit;font-size:12px;font-weight:600;cursor:pointer;transition:all var(--transition)}
        .bulk-btn:hover{box-shadow:var(--shadow-sm)}
        .bulk-btn.on-all{border-color:var(--accent-green);color:var(--accent-green)}
        .bulk-btn.on-all:hover{background:var(--accent-green);color:#fff}
        .bulk-btn.off-all{border-color:var(--accent-red);color:var(--accent-red)}
        .bulk-btn.off-all:hover{background:var(--accent-red);color:#fff}
        .bulk-btn.reset{border-color:var(--accent-orange);color:var(--accent-orange)}
        .bulk-btn.reset:hover{background:var(--accent-orange);color:#fff}

        .pwm-slider-wrap{margin-top:10px}
        .pwm-slider-wrap label{font-size:11px;color:var(--text-secondary);font-weight:500}
        .pwm-slider{width:100%;height:4px;border-radius:2px;appearance:none;background:rgba(0,0,0,.08);outline:none;margin-top:4px;cursor:pointer}
        .pwm-slider::-webkit-slider-thumb{appearance:none;width:16px;height:16px;border-radius:50%;background:var(--accent-blue);box-shadow:0 1px 4px rgba(0,0,0,.2);cursor:pointer}
        .pwm-value{font-size:11px;font-weight:700;color:var(--accent-blue);margin-left:8px}

        @media(max-width:1200px){.stats-grid{grid-template-columns:repeat(2,1fr)}.controls-grid{grid-template-columns:repeat(2,1fr)}}
        @media(max-width:900px){.sidebar{transform:translateX(-100%)}.sidebar.open{transform:translateX(0);box-shadow:var(--shadow-xl)}.main{margin-left:0;max-width:100vw;padding:20px 16px}.menu-toggle{display:flex}.content-grid,.full-grid{grid-template-columns:1fr}}
        @media(max-width:600px){.stats-grid{grid-template-columns:1fr}.devices-grid{grid-template-columns:1fr}.controls-grid{grid-template-columns:1fr}.form-row{grid-template-columns:1fr}.gpio-grid{grid-template-columns:1fr}.header-left h2{font-size:22px}}
    </style>
</head>
<body>
    <div class="bg-blobs"><div class="blob blob-1"></div><div class="blob blob-2"></div><div class="blob blob-3"></div></div>
    <div class="app">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-brand">
                <div class="brand-icon"><svg viewBox="0 0 24 24"><path d="M12 2L2 7v10l10 5 10-5V7L12 2zm0 2.18L19.35 7.5 12 10.82 4.65 7.5 12 4.18zM4 8.9l7 3.5v7.7l-7-3.5V8.9zm9 11.2V12.4l7-3.5v7.7l-7 3.5z"/></svg></div>
                <div class="brand-text"><h1>SmartVillage</h1><span>IoT Management</span></div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Main</div>
                <div class="nav-item active" data-page="dashboard" onclick="switchPage('dashboard',this)"><svg viewBox="0 0 24 24"><path d="M4 13h6c.55 0 1-.45 1-1V4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zm0 8h6c.55 0 1-.45 1-1v-4c0-.55-.45-1-1-1H4c-.55 0-1 .45-1 1v4c0 .55.45 1 1 1zm10 0h6c.55 0 1-.45 1-1v-8c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1v8c0 .55.45 1 1 1zm-1-18v4c0 .55.45 1 1 1h6c.55 0 1-.45 1-1V3c0-.55-.45-1-1-1h-6c-.55 0-1 .45-1 1z"/></svg>Dashboard</div>
                <div class="nav-item" data-page="potholes" onclick="switchPage('potholes',this)"><svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>Potholes<span class="nav-badge" id="navPotholeBadge">0</span></div>
                <div class="nav-item" data-page="devices" onclick="switchPage('devices',this)"><svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>Devices</div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Infrastructure</div>
                <div class="nav-item" data-page="lighting" onclick="switchPage('lighting',this)"><svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>Street Lights</div>
                <div class="nav-item" data-page="water" onclick="switchPage('water',this)"><svg viewBox="0 0 24 24"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z"/></svg>Water Supply</div>
                <div class="nav-item" data-page="waste" onclick="switchPage('waste',this)"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>Waste Mgmt</div>
            </div>
            <div class="nav-section">
                <div class="nav-label">Advanced</div>
                <div class="nav-item" data-page="misc" onclick="switchPage('misc',this)"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg>Misc / GPIO</div>
                <div class="nav-item" data-page="terminal" onclick="switchPage('terminal',this)"><svg viewBox="0 0 24 24"><path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm0 14H4V8h16v10zm-2-1h-6v-2h6v2zM7.5 17l-1.41-1.41L8.67 13l-2.59-2.59L7.5 9l4 4-4 4z"/></svg>Terminal</div>
            </div>
            <div class="sidebar-footer"><div class="user-info"><div class="user-avatar">VP</div><div class="user-details"><h4>Village Panchayat</h4><span>Admin Access</span></div></div></div>
        </aside>

        <main class="main">
            <div class="header">
                <div style="display:flex;align-items:center;gap:12px">
                    <div class="menu-toggle" onclick="toggleSidebar()"><svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg></div>
                    <div class="header-left"><h2 id="pageTitle">Dashboard</h2><p id="pageSubtitle">Live data from ESP32-1 & ESP32-2</p></div>
                </div>
                <div class="header-right">
                    <div class="conn-indicator offline" id="connIndicator">‚è≥ Connecting</div>
                    <div class="live-indicator"><div class="live-dot"></div>LIVE</div>
                    <div class="header-btn" onclick="openReportModal()" title="Report Pothole"><svg viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z" fill="#86868b"/></svg></div>
                    <div class="header-btn" title="Notifications"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg><div class="notif-dot" id="notifDot"></div></div>
                </div>
            </div>

            <!-- DASHBOARD -->
            <div class="page active" id="page-dashboard">
                <div class="status-bar" id="systemStatusBar"><div class="status-dot" id="systemStatusDot"></div><span id="systemStatusText">Connecting...</span><span class="status-time" id="liveTime"></span></div>
                <div class="gps-bar" id="gpsBar"><span>üìç</span><span class="gps-text" id="gpsStatusText">GPS: Searching...</span><span class="gps-coords" id="gpsCoordsDisplay">---, ---</span></div>
                <div class="stats-grid">
                    <div class="stat-card"><div class="stat-header"><div class="stat-icon red"><svg viewBox="0 0 24 24"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg></div><span class="stat-trend up" id="potholeTrend">--</span></div><div class="stat-value" id="potholeCount">0</div><div class="stat-label">Active Potholes</div></div>
                    <div class="stat-card"><div class="stat-header"><div class="stat-icon green"><svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg></div><span class="stat-trend down" id="lightsTrend">--</span></div><div class="stat-value" id="lightsOn">--</div><div class="stat-label">Street Lights</div><div class="stat-sub" id="ldrDisplay">LDR: --</div></div>
                    <div class="stat-card"><div class="stat-header"><div class="stat-icon blue"><svg viewBox="0 0 24 24"><path d="M12 2c-5.33 4.55-8 8.48-8 11.8 0 4.98 3.8 8.2 8 8.2s8-3.22 8-8.2c0-3.32-2.67-7.25-8-11.8z"/></svg></div><span class="stat-trend down" id="waterTrend">--</span></div><div class="stat-value" id="waterLevel">--</div><div class="stat-label">Water Level</div><div class="stat-sub" id="waterAlertDisplay">Alerts: 0</div></div>
                    <div class="stat-card"><div class="stat-header"><div class="stat-icon orange"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div><span class="stat-trend up" id="wasteTrend">--</span></div><div class="stat-value" id="wasteBins">--</div><div class="stat-label">Dustbin Fill</div><div class="stat-sub" id="gasDisplay">Gas: --</div></div>
                </div>
                <div class="content-grid">
                    <div class="card"><div class="card-header"><h3>üó∫Ô∏è Live Pothole Map</h3><span class="card-header-action" id="mapPinCount">üìç 0</span></div><div class="card-body"><div class="map-container" id="mainMapContainer"></div><div class="map-controls-bar"><button class="map-ctrl-btn" onclick="centerMapOnGPS()">üìç GPS</button><button class="map-ctrl-btn" onclick="fitAllMarkers()">üîç Fit All</button><button class="map-ctrl-btn" onclick="addPotholeAtCenter()">‚ûï Add</button></div><div class="map-legend"><div class="legend-item"><div class="legend-dot" style="background:var(--accent-red)"></div>Critical</div><div class="legend-item"><div class="legend-dot" style="background:var(--accent-orange)"></div>Warning</div><div class="legend-item"><div class="legend-dot" style="background:var(--accent-yellow)"></div>Minor</div></div></div></div>
                    <div class="card"><div class="card-header"><h3>üìã Recent Reports</h3><span class="card-header-action" onclick="switchPage('potholes',document.querySelector('[data-page=potholes]'))">View All ‚Üí</span></div><div class="card-body"><div class="pothole-list" id="dashboardPotholeList"><div style="text-align:center;padding:20px;color:var(--text-tertiary);font-size:13px">Waiting for data...</div></div></div></div>
                </div>
                <div class="full-grid">
                    <div class="card"><div class="card-header"><h3>üìä Live Sensors</h3><span class="card-header-action" id="sensorUpdateTime">--</span></div><div class="card-body"><div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px">
                        <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:24px;font-weight:800" id="sensorDistance">--</div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Road Dist (cm)</div></div>
                        <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:24px;font-weight:800" id="sensorBaseline">--</div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Baseline (cm)</div></div>
                        <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:24px;font-weight:800" id="sensorGas">--</div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Gas Level</div></div>
                        <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:24px;font-weight:800" id="sensorDustbin">--</div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">Dustbin %</div></div>
                        <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:24px;font-weight:800" id="sensorLDR">--</div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">LDR Value</div></div>
                        <div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:24px;font-weight:800" id="sensorSats">--</div><div style="font-size:12px;color:var(--text-secondary);margin-top:4px">GPS Sats</div></div>
                    </div></div></div>
                    <div class="card"><div class="card-header"><h3>üîî Alerts</h3><span class="card-header-action" onclick="clearAlerts()">Clear</span></div><div class="card-body"><div class="alerts-list" id="alertsList"><div class="alert-item"><div class="alert-dot blue"></div><div class="alert-content"><h4>System Starting</h4><p>Waiting for ESP32...</p></div><span class="alert-time">Now</span></div></div></div></div>
                </div>
                <div class="controls-grid">
                    <div class="card"><div class="card-header"><h3>üéÆ Controls</h3></div><div class="card-body"><div class="devices-grid">
                        <div class="device-card"><div class="device-card-header"><div class="device-icon-wrap" style="background:linear-gradient(135deg,#ffcc00,#ff9500)"><svg viewBox="0 0 24 24"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg></div><div class="toggle" id="ledToggle" onclick="toggleControl('led')"><div class="toggle-knob"></div></div></div><div class="device-name">Street Lights</div><div class="device-status" id="ledStatus">Auto (LDR)</div></div>
                        <div class="device-card"><div class="device-card-header"><div class="device-icon-wrap" style="background:linear-gradient(135deg,#5ac8fa,#007aff)"><svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg></div><div class="toggle" id="relayToggle" onclick="toggleControl('relay')"><div class="toggle-knob"></div></div></div><div class="device-name">Dustbin Lid</div><div class="device-status" id="relayStatus">Closed</div></div>
                        <div class="device-card"><div class="device-card-header"><div class="device-icon-wrap" style="background:linear-gradient(135deg,#ff3b30,#ff6259)"><svg viewBox="0 0 24 24"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg></div><div class="toggle" id="buzzerToggle" onclick="toggleControl('buzzer')"><div class="toggle-knob"></div></div></div><div class="device-name">Alert LEDs</div><div class="device-status" id="buzzerStatus">Off</div></div>
                        <div class="device-card" onclick="switchPage('misc',document.querySelector('[data-page=misc]'))"><div class="device-card-header"><div class="device-icon-wrap" style="background:linear-gradient(135deg,#af52de,#5856d6)"><svg viewBox="0 0 24 24"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 00.12-.61l-1.92-3.32a.488.488 0 00-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58zM12 15.6c-1.98 0-3.6-1.62-3.6-3.6s1.62-3.6 3.6-3.6 3.6 1.62 3.6 3.6-1.62 3.6-3.6 3.6z"/></svg></div></div><div class="device-name">GPIO Control</div><div class="device-status" style="color:var(--accent-blue)">Individual pin control ‚Üí</div></div>
                    </div></div></div>
                    <div class="card"><div class="card-header"><h3>üíß Water Tank</h3></div><div class="card-body"><div class="gauge-container"><svg class="gauge-svg" viewBox="0 0 120 120"><circle class="gauge-bg" cx="60" cy="60" r="50"/><circle class="gauge-fill" cx="60" cy="60" r="50" stroke="url(#wg)" stroke-dasharray="314" stroke-dashoffset="314" id="waterGaugeFill"/><defs><linearGradient id="wg" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#007aff"/><stop offset="100%" stop-color="#5ac8fa"/></linearGradient></defs><text class="gauge-text" x="60" y="56"><tspan class="gauge-value" id="gaugeVal">--</tspan></text><text class="gauge-text" x="60" y="72"><tspan class="gauge-unit" id="gaugeUnit">waiting</tspan></text></svg><div class="gauge-label">Water Level</div><div class="gauge-sublabel">Float sensor ESP32-2</div></div></div></div>
                    <div class="card"><div class="card-header"><h3>‚ö° Quick Actions</h3></div><div class="card-body"><div class="quick-actions">
                        <button class="action-btn" onclick="openReportModal()"><svg viewBox="0 0 24 24" fill="#ff3b30"><path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/></svg>Report Pothole<svg class="action-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
                        <button class="action-btn" onclick="sendControl('buzzer',true,'üîî Alert!','ESP32-2 LEDs flash')"><svg viewBox="0 0 24 24" fill="#ff9500"><path d="M12 22c1.1 0 2-.9 2-2h-4c0 1.1.89 2 2 2zm6-6v-5c0-3.07-1.64-5.64-4.5-6.32V4c0-.83-.67-1.5-1.5-1.5s-1.5.67-1.5 1.5v.68C7.63 5.36 6 7.92 6 11v5l-2 2v1h16v-1l-2-2z"/></svg>Trigger Alert<svg class="action-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
                        <button class="action-btn" onclick="sendControl('relay',true,'üìÇ Opening','Relay HIGH')"><svg viewBox="0 0 24 24" fill="#007aff"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12z"/></svg>Open Dustbin<svg class="action-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
                        <button class="action-btn" onclick="switchPage('misc',document.querySelector('[data-page=misc]'))"><svg viewBox="0 0 24 24" fill="#af52de"><path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58c.18-.14.23-.41.12-.61l-1.92-3.32c-.12-.22-.37-.29-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54c-.04-.24-.24-.41-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96c-.22-.08-.47 0-.59.22L2.74 8.87c-.12.21-.08.47.12.61l2.03 1.58c-.05.3-.07.62-.07.94s.02.64.07.94l-2.03 1.58a.49.49 0 00-.12.61l1.92 3.32c.12.22.37.29.59.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.05.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.47 0 .59-.22l1.92-3.32c.12-.22.07-.47-.12-.61l-2.01-1.58z"/></svg>Individual GPIO Control ‚Üí<svg class="action-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
                        <button class="action-btn" onclick="resetAllControls()"><svg viewBox="0 0 24 24" fill="#86868b"><path d="M17.65 6.35A7.958 7.958 0 0012 4c-4.42 0-7.99 3.58-7.99 8s3.57 8 7.99 8c3.73 0 6.84-2.55 7.73-6h-2.08A5.99 5.99 0 0112 18c-3.31 0-6-2.69-6-6s2.69-6 6-6c1.66 0 3.14.69 4.22 1.78L13 11h7V4l-2.35 2.35z"/></svg>Reset All<svg class="action-arrow" viewBox="0 0 24 24"><path d="M10 6L8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"/></svg></button>
                    </div></div></div>
                </div>
            </div>

            <!-- POTHOLES -->
            <div class="page" id="page-potholes"><div class="content-grid"><div class="card"><div class="card-header"><h3>Map</h3></div><div class="card-body"><div class="map-container" id="potholePageMap"></div></div></div><div class="card"><div class="card-header"><h3>All Reports</h3><span class="card-header-action" onclick="openReportModal()">+ Report</span></div><div class="card-body"><div class="pothole-list" id="allPotholeList"><div style="text-align:center;padding:20px;color:var(--text-tertiary)">Loading...</div></div></div></div></div></div>

            <!-- DEVICES -->
            <div class="page" id="page-devices"><div class="card"><div class="card-header"><h3>ESP32 Status</h3></div><div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px">
                <div style="padding:20px;background:var(--bg);border-radius:var(--radius-sm);border-left:4px solid var(--accent-blue)"><div style="font-size:16px;font-weight:700;margin-bottom:8px">ESP32-1</div><div style="font-size:13px;color:var(--text-secondary)">Pothole + Lights + GPS</div><div style="font-size:14px;font-weight:600;margin-top:8px" id="esp1StatusDisplay">‚è≥ Waiting...</div><div style="font-size:12px;color:var(--text-tertiary);margin-top:4px" id="esp1Uptime">Uptime: --</div></div>
                <div style="padding:20px;background:var(--bg);border-radius:var(--radius-sm);border-left:4px solid var(--accent-green)"><div style="font-size:16px;font-weight:700;margin-bottom:8px">ESP32-2</div><div style="font-size:13px;color:var(--text-secondary)">Dustbin + Water + Gas</div><div style="font-size:14px;font-weight:600;margin-top:8px" id="esp2StatusDisplay">‚è≥ Waiting...</div><div style="font-size:12px;color:var(--text-tertiary);margin-top:4px" id="esp2Uptime">Uptime: --</div></div>
            </div></div></div></div>

            <!-- LIGHTING -->
            <div class="page" id="page-lighting"><div class="card"><div class="card-header"><h3>Street Lights</h3></div><div class="card-body"><div style="text-align:center;padding:40px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:48px;font-weight:800" id="lightPageStatus">--</div><div style="font-size:14px;color:var(--text-secondary);margin-top:8px" id="lightPageLDR">LDR: --</div><div style="margin-top:20px"><div class="toggle" id="ledTogglePage" onclick="toggleControl('led')" style="margin:0 auto"><div class="toggle-knob"></div></div><div style="font-size:12px;color:var(--text-secondary);margin-top:8px">Manual Override</div></div></div></div></div></div>

            <!-- WATER -->
            <div class="page" id="page-water"><div class="card"><div class="card-header"><h3>Water Level</h3></div><div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr;gap:16px"><div style="text-align:center;padding:40px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:48px;font-weight:800" id="waterPageStatus">--</div><div style="font-size:12px;color:var(--text-tertiary);margin-top:4px" id="waterPageAlerts">Alerts: 0</div></div><div style="padding:30px;background:var(--bg);border-radius:var(--radius-sm)"><h4 style="margin-bottom:16px;font-size:14px">Tank</h4><div class="water-tank"><div class="water-tank-fill" id="waterVisual" style="height:45%"></div><div class="water-tank-text" id="waterVisualText">Normal</div></div></div></div></div></div></div>

            <!-- WASTE -->
            <div class="page" id="page-waste"><div class="card"><div class="card-header"><h3>Smart Dustbin</h3></div><div class="card-body"><div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;margin-bottom:16px"><div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:28px;font-weight:800" id="wastePageFill">--</div><div style="font-size:12px;color:var(--text-secondary)">Fill</div></div><div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:28px;font-weight:800" id="wastePageGas">--</div><div style="font-size:12px;color:var(--text-secondary)">Gas</div></div><div style="text-align:center;padding:16px;background:var(--bg);border-radius:var(--radius-sm)"><div style="font-size:28px;font-weight:800" id="wastePageLid">--</div><div style="font-size:12px;color:var(--text-secondary)">Lid</div></div></div><div style="display:flex;justify-content:space-between;margin-bottom:4px"><span style="font-size:12px;color:var(--text-secondary)">Fill</span><span style="font-size:12px;font-weight:600" id="wastePercentText">0%</span></div><div class="progress-bar"><div class="progress-fill orange" id="wasteProgressBar" style="width:0%"></div></div></div></div></div>

            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <!-- ‚òÖ‚òÖ‚òÖ MISC / GPIO CONTROL PAGE ‚òÖ‚òÖ‚òÖ -->
            <!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
            <div class="page" id="page-misc">
                <!-- ESP32-1 GPIO Section -->
                <div class="esp-section">
                    <div class="esp-section-title">
                        <h4>ESP32-1 GPIO Control</h4>
                        <span class="esp-tag blue">GPIO 25, 26, 27, 13</span>
                        <span style="font-size:11px;color:var(--text-tertiary);margin-left:auto" id="esp1GpioStatus">‚è≥</span>
                    </div>
                    <div class="bulk-actions">
                        <button class="bulk-btn on-all" onclick="bulkGPIO('esp1',true)">‚ö° All ON</button>
                        <button class="bulk-btn off-all" onclick="bulkGPIO('esp1',false)">üí§ All OFF</button>
                        <button class="bulk-btn reset" onclick="resetGPIO('esp1')">üîÑ Reset to Auto</button>
                    </div>
                    <div class="gpio-grid">
                        <div class="gpio-card" id="gpio-esp1-25">
                            <div class="gpio-card-header">
                                <span class="gpio-pin-badge esp1">ESP1 ¬∑ GPIO 25</span>
                                <div class="gpio-indicator off" id="gpio-ind-esp1-25"></div>
                            </div>
                            <div class="gpio-name">üí° Street Light 1</div>
                            <div class="gpio-desc">LED_STREET_1 ‚Äî PWM Channel 0</div>
                            <div class="gpio-status">
                                <span class="gpio-state off" id="gpio-state-esp1-25">OFF</span>
                                <div class="toggle" id="gpio-toggle-esp1-25" onclick="toggleGPIO('esp1','gpio25')"><div class="toggle-knob"></div></div>
                            </div>
                            <div class="pwm-slider-wrap">
                                <label>PWM: <span class="pwm-value" id="pwm-val-esp1-25">0</span></label>
                                <input type="range" class="pwm-slider" min="0" max="255" value="0" id="pwm-esp1-25" oninput="setGPIOPWM('esp1','gpio25',this.value)">
                            </div>
                        </div>
                        <div class="gpio-card" id="gpio-esp1-26">
                            <div class="gpio-card-header">
                                <span class="gpio-pin-badge esp1">ESP1 ¬∑ GPIO 26</span>
                                <div class="gpio-indicator off" id="gpio-ind-esp1-26"></div>
                            </div>
                            <div class="gpio-name">üí° Street Light 2</div>
                            <div class="gpio-desc">LED_STREET_2 ‚Äî PWM Channel 1</div>
                            <div class="gpio-status">
                                <span class="gpio-state off" id="gpio-state-esp1-26">OFF</span>
                                <div class="toggle" id="gpio-toggle-esp1-26" onclick="toggleGPIO('esp1','gpio26')"><div class="toggle-knob"></div></div>
                            </div>
                            <div class="pwm-slider-wrap">
                                <label>PWM: <span class="pwm-value" id="pwm-val-esp1-26">0</span></label>
                                <input type="range" class="pwm-slider" min="0" max="255" value="0" id="pwm-esp1-26" oninput="setGPIOPWM('esp1','gpio26',this.value)">
                            </div>
                        </div>
                        <div class="gpio-card" id="gpio-esp1-27">
                            <div class="gpio-card-header">
                                <span class="gpio-pin-badge esp1">ESP1 ¬∑ GPIO 27</span>
                                <div class="gpio-indicator off" id="gpio-ind-esp1-27"></div>
                            </div>
                            <div class="gpio-name">üí° Street Light 3</div>
                            <div class="gpio-desc">LED_STREET_3 ‚Äî PWM Channel 2</div>
                            <div class="gpio-status">
                                <span class="gpio-state off" id="gpio-state-esp1-27">OFF</span>
                                <div class="toggle" id="gpio-toggle-esp1-27" onclick="toggleGPIO('esp1','gpio27')"><div class="toggle-knob"></div></div>
                            </div>
                            <div class="pwm-slider-wrap">
                                <label>PWM: <span class="pwm-value" id="pwm-val-esp1-27">0</span></label>
                                <input type="range" class="pwm-slider" min="0" max="255" value="0" id="pwm-esp1-27" oninput="setGPIOPWM('esp1','gpio27',this.value)">
                            </div>
                        </div>
                        <div class="gpio-card" id="gpio-esp1-13">
                            <div class="gpio-card-header">
                                <span class="gpio-pin-badge esp1">ESP1 ¬∑ GPIO 13</span>
                                <div class="gpio-indicator off" id="gpio-ind-esp1-13"></div>
                            </div>
                            <div class="gpio-name">üîî Buzzer</div>
                            <div class="gpio-desc">BUZZER_PIN ‚Äî Digital OUT</div>
                            <div class="gpio-status">
                                <span class="gpio-state off" id="gpio-state-esp1-13">OFF</span>
                                <div class="toggle" id="gpio-toggle-esp1-13" onclick="toggleGPIO('esp1','gpio13')"><div class="toggle-knob"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- ESP32-2 GPIO Section -->
                <div class="esp-section">
                    <div class="esp-section-title">
                        <h4>ESP32-2 GPIO Control</h4>
                        <span class="esp-tag green">GPIO 26, 25, 27</span>
                        <span style="font-size:11px;color:var(--text-tertiary);margin-left:auto" id="esp2GpioStatus">‚è≥</span>
                    </div>
                    <div class="bulk-actions">
                        <button class="bulk-btn on-all" onclick="bulkGPIO('esp2',true)">‚ö° All ON</button>
                        <button class="bulk-btn off-all" onclick="bulkGPIO('esp2',false)">üí§ All OFF</button>
                        <button class="bulk-btn reset" onclick="resetGPIO('esp2')">üîÑ Reset to Auto</button>
                    </div>
                    <div class="gpio-grid">
                        <div class="gpio-card" id="gpio-esp2-26">
                            <div class="gpio-card-header">
                                <span class="gpio-pin-badge esp2">ESP2 ¬∑ GPIO 26</span>
                                <div class="gpio-indicator off" id="gpio-ind-esp2-26"></div>
                            </div>
                            <div class="gpio-name">üìÇ Relay (Dustbin Lid)</div>
                            <div class="gpio-desc">RELAY_PIN ‚Äî Controls lid servo/motor</div>
                            <div class="gpio-status">
                                <span class="gpio-state off" id="gpio-state-esp2-26">OFF</span>
                                <div class="toggle" id="gpio-toggle-esp2-26" onclick="toggleGPIO('esp2','gpio26')"><div class="toggle-knob"></div></div>
                            </div>
                        </div>
                        <div class="gpio-card" id="gpio-esp2-25">
                            <div class="gpio-card-header">
                                <span class="gpio-pin-badge esp2">ESP2 ¬∑ GPIO 25</span>
                                <div class="gpio-indicator off" id="gpio-ind-esp2-25"></div>
                            </div>
                            <div class="gpio-name">üî¥ Dustbin Full LED</div>
                            <div class="gpio-desc">LED_DUSTBIN_FULL ‚Äî Blinks when full</div>
                            <div class="gpio-status">
                                <span class="gpio-state off" id="gpio-state-esp2-25">OFF</span>
                                <div class="toggle" id="gpio-toggle-esp2-25" onclick="toggleGPIO('esp2','gpio25')"><div class="toggle-knob"></div></div>
                            </div>
                        </div>
                        <div class="gpio-card" id="gpio-esp2-27">
                            <div class="gpio-card-header">
                                <span class="gpio-pin-badge esp2">ESP2 ¬∑ GPIO 27</span>
                                <div class="gpio-indicator off" id="gpio-ind-esp2-27"></div>
                            </div>
                            <div class="gpio-name">üåä Water Alert LED</div>
                            <div class="gpio-desc">LED_WATER_ALERT ‚Äî ON when water HIGH</div>
                            <div class="gpio-status">
                                <span class="gpio-state off" id="gpio-state-esp2-27">OFF</span>
                                <div class="toggle" id="gpio-toggle-esp2-27" onclick="toggleGPIO('esp2','gpio27')"><div class="toggle-knob"></div></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- GPIO Command Log -->
                <div class="card">
                    <div class="card-header"><h3>üìü GPIO Command Log</h3><span class="card-header-action" onclick="clearGpioLog()">Clear</span></div>
                    <div class="card-body">
                        <div class="command-log" id="gpioLog">
                            <div class="cmd-line"><span class="cmd-time">[info]</span> <span class="cmd-info">GPIO controls write to /gpio/esp1/* and /gpio/esp2/*</span></div>
                            <div class="cmd-line"><span class="cmd-time">[info]</span> <span class="cmd-info">Add the ESP32 code snippet (shown below) to read these paths</span></div>
                        </div>
                    </div>
                </div>

                <!-- ESP32 Code Help -->
                <div class="card" style="margin-top:16px">
                    <div class="card-header"><h3>üìù ESP32 Code to Add</h3><span class="card-header-action" onclick="copyESPCode()">üìã Copy</span></div>
                    <div class="card-body">
                        <div class="command-log" id="espCodeBlock" style="max-height:400px;color:#e0e0e0;white-space:pre-wrap;font-size:10px">// ‚ïê‚ïê‚ïê Add to ESP32-1 readFirebaseControls() ‚ïê‚ïê‚ïê
// Individual GPIO control from dashboard
if (Firebase.RTDB.getBool(&fbdoRead, "/gpio/esp1/gpio25")) {
    bool state = fbdoRead.boolData();
    ledcWrite(0, state ? 255 : 0);  // PWM channel 0
}
if (Firebase.RTDB.getBool(&fbdoRead, "/gpio/esp1/gpio26")) {
    bool state = fbdoRead.boolData();
    ledcWrite(1, state ? 255 : 0);  // PWM channel 1
}
if (Firebase.RTDB.getBool(&fbdoRead, "/gpio/esp1/gpio27")) {
    bool state = fbdoRead.boolData();
    ledcWrite(2, state ? 255 : 0);  // PWM channel 2
}
if (Firebase.RTDB.getBool(&fbdoRead, "/gpio/esp1/gpio13")) {
    digitalWrite(BUZZER_PIN, fbdoRead.boolData() ? HIGH : LOW);
}
// Optional: PWM slider support
if (Firebase.RTDB.getInt(&fbdoRead, "/gpio/esp1/pwm25")) {
    ledcWrite(0, fbdoRead.intData());
}
if (Firebase.RTDB.getInt(&fbdoRead, "/gpio/esp1/pwm26")) {
    ledcWrite(1, fbdoRead.intData());
}
if (Firebase.RTDB.getInt(&fbdoRead, "/gpio/esp1/pwm27")) {
    ledcWrite(2, fbdoRead.intData());
}

// ‚ïê‚ïê‚ïê Add to ESP32-2 readFirebaseControls() ‚ïê‚ïê‚ïê
if (Firebase.RTDB.getBool(&fbdoRead, "/gpio/esp2/gpio26")) {
    digitalWrite(RELAY_PIN, fbdoRead.boolData() ? HIGH : LOW);
}
if (Firebase.RTDB.getBool(&fbdoRead, "/gpio/esp2/gpio25")) {
    digitalWrite(LED_DUSTBIN_FULL, fbdoRead.boolData() ? HIGH : LOW);
}
if (Firebase.RTDB.getBool(&fbdoRead, "/gpio/esp2/gpio27")) {
    digitalWrite(LED_WATER_ALERT, fbdoRead.boolData() ? HIGH : LOW);
}</div>
                    </div>
                </div>
            </div>

            <!-- TERMINAL -->
            <div class="page" id="page-terminal"><div class="card"><div class="card-header"><h3>üìü Terminal</h3><span class="card-header-action" onclick="clearCommandLog()">Clear</span></div><div class="card-body"><div class="command-log" id="commandLog"><div class="cmd-line"><span class="cmd-time">[boot]</span> <span class="cmd-info">SmartVillage Terminal</span></div></div><div style="display:flex;gap:8px;margin-top:12px"><input type="text" class="form-input" id="terminalInput" placeholder="led on, relay off, gpio esp1 25 on, help..." style="flex:1" onkeypress="if(event.key==='Enter')executeCommand()"><button class="btn btn-primary" onclick="executeCommand()" style="flex:none;width:80px">Send</button></div><div style="display:flex;gap:6px;margin-top:8px;flex-wrap:wrap"><button class="map-ctrl-btn" onclick="runQuickCmd('led on')">led on</button><button class="map-ctrl-btn" onclick="runQuickCmd('led off')">led off</button><button class="map-ctrl-btn" onclick="runQuickCmd('relay on')">relay on</button><button class="map-ctrl-btn" onclick="runQuickCmd('relay off')">relay off</button><button class="map-ctrl-btn" onclick="runQuickCmd('buzzer on')">buzzer on</button><button class="map-ctrl-btn" onclick="runQuickCmd('gpio esp1 25 on')">gpio25 on</button><button class="map-ctrl-btn" onclick="runQuickCmd('gpio esp1 25 off')">gpio25 off</button><button class="map-ctrl-btn" onclick="runQuickCmd('status')">status</button><button class="map-ctrl-btn" onclick="runQuickCmd('reset')">reset</button></div></div></div></div>
        </main>
    </div>

    <!-- REPORT MODAL -->
    <div class="modal-overlay" id="reportModal"><div class="modal"><h3>üìç Report Pothole</h3><p>Click map or enter coords.</p><div class="form-group"><label>Location</label><input type="text" class="form-input" id="reportLocation" placeholder="Main Bazaar Road"></div><div class="form-row"><div class="form-group"><label>Severity</label><select class="form-input" id="reportSeverity"><option value="minor">Minor</option><option value="warning" selected>Warning</option><option value="critical">Critical</option></select></div><div class="form-group"><label>Size</label><select class="form-input" id="reportSize"><option>Small</option><option selected>Medium</option><option>Large</option></select></div></div><div class="form-group"><label>Description</label><textarea class="form-input" id="reportDesc" placeholder="Details..."></textarea></div><div class="form-row"><div class="form-group"><label>Lat</label><input type="number" step="0.000001" class="form-input" id="reportLat"></div><div class="form-group"><label>Lng</label><input type="number" step="0.000001" class="form-input" id="reportLng"></div></div><div class="form-group"><label>Pick on Map</label><div class="modal-map-container" id="modalMapContainer"></div><button class="map-pick-btn" onclick="useCurrentLocation()">üìç Use GPS</button></div><div class="modal-actions"><button class="btn btn-secondary" onclick="closeReportModal()">Cancel</button><button class="btn btn-primary" id="submitReportBtn" onclick="submitReport()">Submit</button></div></div></div>
    <div class="toast-container" id="toastContainer"></div>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script>
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FIREBASE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    firebase.initializeApp({apiKey:"AIzaSyAwEExMpZV7NXQjG--d3LKIk4ZWhdFANCU",authDomain:"pothole-detection-90641.firebaseapp.com",databaseURL:"https://pothole-detection-90641-default-rtdb.firebaseio.com",projectId:"pothole-detection-90641"});
    const db=firebase.database();

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  STATE
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let currentGPS={lat:20.5937,lng:78.9629,fixed:false};
    let mainMap,potholePageMap,modalMap,modalMapMarker=null;
    let mapMarkers=[],pMapMarkers=[];
    let esp1Online=false,esp2Online=false;
    let controlState={led:false,relay:false,buzzer:false};
    // GPIO states
    let gpioState={
        esp1:{gpio25:false,gpio26:false,gpio27:false,gpio13:false,pwm25:0,pwm26:0,pwm27:0},
        esp2:{gpio26:false,gpio25:false,gpio27:false}
    };

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  LEAFLET
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function makeIcon(color,size=24){const c={red:'#ff3b30',orange:'#ff9500',yellow:'#ffcc00',blue:'#007aff',green:'#34c759'}[color]||color;return L.divIcon({className:'',html:`<div style="width:${size}px;height:${size}px;background:${c};border-radius:50% 50% 50% 0;transform:rotate(-45deg);border:3px solid #fff;box-shadow:0 2px 8px rgba(0,0,0,.3);display:flex;align-items:center;justify-content:center"><div style="width:${size/3}px;height:${size/3}px;background:#fff;border-radius:50%;transform:rotate(45deg)"></div></div>`,iconSize:[size,size],iconAnchor:[size/2,size],popupAnchor:[0,-size]})}
    function espIcon(){return L.divIcon({className:'',html:`<div style="width:32px;height:32px;background:linear-gradient(135deg,#007aff,#5856d6);border-radius:50%;border:3px solid #fff;box-shadow:0 2px 12px rgba(0,122,255,.4);display:flex;align-items:center;justify-content:center"><div style="width:12px;height:12px;background:#fff;border-radius:50%"></div></div>`,iconSize:[32,32],iconAnchor:[16,16],popupAnchor:[0,-20]})}
    let espMarker=null;
    function initMaps(){
        mainMap=L.map('mainMapContainer').setView([currentGPS.lat,currentGPS.lng],14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬© <a href="https://openstreetmap.org/copyright">OSM</a>',maxZoom:19}).addTo(mainMap);
        potholePageMap=L.map('potholePageMap').setView([currentGPS.lat,currentGPS.lng],14);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(potholePageMap);
        setTimeout(()=>{mainMap.invalidateSize();potholePageMap.invalidateSize()},400);
    }
    function initModalMap(){if(modalMap)modalMap.remove();setTimeout(()=>{modalMap=L.map('modalMapContainer',{zoomControl:false}).setView([currentGPS.lat,currentGPS.lng],15);L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19}).addTo(modalMap);modalMap.on('click',e=>{document.getElementById('reportLat').value=e.latlng.lat.toFixed(6);document.getElementById('reportLng').value=e.latlng.lng.toFixed(6);if(modalMapMarker)modalMap.removeLayer(modalMapMarker);modalMapMarker=L.marker([e.latlng.lat,e.latlng.lng],{icon:makeIcon('purple',28)}).addTo(modalMap)});setTimeout(()=>modalMap.invalidateSize(),200)},300)}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  FIREBASE LISTENERS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    db.ref('/esp1/pothole').on('value',s=>{const d=s.val();if(!d)return;document.getElementById('potholeCount').textContent=d.totalCount||0;document.getElementById('navPotholeBadge').textContent=d.totalCount||0;document.getElementById('potholeTrend').textContent=(d.totalCount||0)+' found';document.getElementById('sensorDistance').textContent=(d.currentDistance||0).toFixed(1);document.getElementById('sensorDistance').style.color=d.detected?'var(--accent-red)':'var(--accent-green)';document.getElementById('sensorBaseline').textContent=(d.baseline||0).toFixed(1);if(d.detected){showToast('error','üï≥Ô∏è POTHOLE!','Depth: '+(d.depth||0).toFixed(1)+'cm');addAlert('red','üï≥Ô∏è Pothole!','Depth:'+(d.depth||0).toFixed(1)+'cm')}});
    db.ref('/esp1/streetLights').on('value',s=>{const d=s.val();if(!d)return;document.getElementById('lightsOn').textContent=d.isOn?'ON':'OFF';document.getElementById('lightsOn').style.color=d.isOn?'var(--accent-green)':'var(--text-tertiary)';document.getElementById('lightsTrend').textContent=d.isOn?'Active':'Off';document.getElementById('lightsTrend').className='stat-trend '+(d.isOn?'down':'up');document.getElementById('ldrDisplay').textContent='LDR: '+(d.ldrValue||'--')+' | Brightness: '+(d.brightness||0);document.getElementById('sensorLDR').textContent=d.ldrValue||'--';document.getElementById('lightPageStatus').textContent=d.isOn?'üí° ON':'üåô OFF';document.getElementById('lightPageLDR').textContent='LDR: '+(d.ldrValue||'--')+' | PWM: '+(d.brightness||0)});
    db.ref('/esp1/gps').on('value',s=>{const d=s.val();if(!d)return;document.getElementById('gpsBar').classList.add('show');if(d.fixed&&d.lat!==0){currentGPS={lat:d.lat,lng:d.lng,fixed:true};document.getElementById('gpsStatusText').textContent='GPS ‚úÖ | Sats: '+(d.satellites||0);document.getElementById('gpsCoordsDisplay').textContent=d.lat.toFixed(6)+', '+d.lng.toFixed(6);if(espMarker)mainMap.removeLayer(espMarker);espMarker=L.marker([d.lat,d.lng],{icon:espIcon()}).addTo(mainMap).bindPopup('<strong>ESP32-1</strong>')}else{document.getElementById('gpsStatusText').textContent='Searching... Sats: '+(d.satellites||0);document.getElementById('gpsCoordsDisplay').textContent='No fix'}document.getElementById('sensorSats').textContent=d.satellites||0});
    db.ref('/esp1/status').on('value',s=>{const d=s.val();if(!d)return;esp1Online=d.online||false;document.getElementById('esp1StatusDisplay').textContent=d.online?'üü¢ Online':'üî¥ Offline';document.getElementById('esp1Uptime').textContent='Uptime: '+(d.lastUpdate||0)+'s';document.getElementById('esp1GpioStatus').textContent=d.online?'üü¢ Connected':'üî¥ Offline';updateSystemStatus()});
    db.ref('/esp2/dustbin').on('value',s=>{const d=s.val();if(!d)return;const f=Math.round(d.fillPercent||0);document.getElementById('wasteBins').textContent=f+'%';document.getElementById('wasteBins').style.color=f>80?'var(--accent-red)':f>60?'var(--accent-orange)':'';document.getElementById('wasteTrend').textContent=d.status||'--';document.getElementById('sensorDustbin').textContent=f+'%';document.getElementById('wastePageFill').textContent=f+'%';document.getElementById('wastePageLid').textContent=d.lidOpen?'üìÇ OPEN':'üìÅ Closed';document.getElementById('wasteProgressBar').style.width=f+'%';document.getElementById('wastePercentText').textContent=f+'%';document.getElementById('wasteProgressBar').className='progress-fill '+(f>80?'red':f>50?'orange':'green');document.getElementById('relayStatus').textContent=d.lidOpen?'üìÇ Open':'üìÅ Closed';if(d.status==='FULL')addAlert('red','üóëÔ∏è FULL!',f+'%')});
    db.ref('/esp2/gas').on('value',s=>{const d=s.val();if(!d)return;document.getElementById('gasDisplay').textContent='Gas: '+(d.value||0)+' ('+(d.status||'--')+')';document.getElementById('sensorGas').textContent=d.value||'--';document.getElementById('sensorGas').style.color=d.level===2?'var(--accent-red)':d.level===1?'var(--accent-orange)':'var(--accent-green)';document.getElementById('wastePageGas').textContent=d.value||'--';if(d.level===2){showToast('error','‚ö†Ô∏è GAS!','Val: '+d.value);addAlert('red','üí® GAS!',d.value)}});
    db.ref('/esp2/water').on('value',s=>{const d=s.val();if(!d)return;const h=d.floatHigh;document.getElementById('waterLevel').textContent=h?'‚ö†Ô∏è HIGH':'Normal';document.getElementById('waterLevel').style.color=h?'var(--accent-red)':'var(--accent-green)';document.getElementById('gaugeVal').textContent=h?'!':'OK';document.getElementById('gaugeUnit').textContent=h?'OVERFLOW':'Normal';const gf=document.getElementById('waterGaugeFill');gf.setAttribute('stroke-dashoffset',314-(314*(h?95:45)/100));if(h)gf.setAttribute('stroke','#ff3b30');else gf.setAttribute('stroke','url(#wg)');document.getElementById('waterTrend').textContent=h?'‚ö†Ô∏è':'‚úÖ';document.getElementById('waterTrend').className='stat-trend '+(h?'up':'down');document.getElementById('waterAlertDisplay').textContent='Alerts: '+(d.alertCount||0);document.getElementById('waterPageStatus').textContent=h?'üåä HIGH':'‚úÖ Normal';document.getElementById('waterPageAlerts').textContent='Alerts: '+(d.alertCount||0);document.getElementById('waterVisual').style.height=h?'95%':'45%';document.getElementById('waterVisual').style.background=h?'linear-gradient(180deg,#ef5350,#c62828)':'linear-gradient(180deg,#42a5f5,#1565c0)';document.getElementById('waterVisualText').textContent=h?'‚ö†Ô∏è OVERFLOW':'Normal';if(h)addAlert('red','üåä Overflow!','#'+(d.alertCount||0))});
    db.ref('/esp2/status').on('value',s=>{const d=s.val();if(!d)return;esp2Online=d.online||false;document.getElementById('esp2StatusDisplay').textContent=d.online?'üü¢ Online':'üî¥ Offline';document.getElementById('sensorUpdateTime').textContent='ESP2: '+(d.lastUpdate||0)+'s';document.getElementById('esp2Uptime').textContent='Uptime: '+(d.lastUpdate||0)+'s';document.getElementById('esp2GpioStatus').textContent=d.online?'üü¢ Connected':'üî¥ Offline';updateSystemStatus()});

    // Sync /controls/*
    db.ref('/controls').on('value',s=>{const c=s.val();if(!c)return;controlState={led:!!c.led,relay:!!c.relay,buzzer:!!c.buzzer};syncT('ledToggle',controlState.led);syncT('ledTogglePage',controlState.led);syncT('relayToggle',controlState.relay);syncT('buzzerToggle',controlState.buzzer);document.getElementById('ledStatus').textContent=controlState.led?'üì± Manual ON':'Auto (LDR)';document.getElementById('buzzerStatus').textContent=controlState.buzzer?'üî¥ ACTIVE':'Off'});

    // ‚òÖ‚òÖ‚òÖ Sync /gpio/* states from Firebase ‚òÖ‚òÖ‚òÖ
    db.ref('/gpio/esp1').on('value',s=>{
        const d=s.val();if(!d)return;
        ['gpio25','gpio26','gpio27','gpio13'].forEach(pin=>{
            if(d[pin]!==undefined){
                const num=pin.replace('gpio','');
                gpioState.esp1[pin]=!!d[pin];
                updateGPIOUI('esp1',num,!!d[pin]);
            }
        });
        ['pwm25','pwm26','pwm27'].forEach(pk=>{
            if(d[pk]!==undefined){
                const num=pk.replace('pwm','');
                gpioState.esp1[pk]=d[pk];
                const slider=document.getElementById('pwm-esp1-'+num);
                const valEl=document.getElementById('pwm-val-esp1-'+num);
                if(slider)slider.value=d[pk];
                if(valEl)valEl.textContent=d[pk];
            }
        });
    });
    db.ref('/gpio/esp2').on('value',s=>{
        const d=s.val();if(!d)return;
        ['gpio26','gpio25','gpio27'].forEach(pin=>{
            if(d[pin]!==undefined){
                const num=pin.replace('gpio','');
                gpioState.esp2[pin]=!!d[pin];
                updateGPIOUI('esp2',num,!!d[pin]);
            }
        });
    });

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  GPIO CONTROL FUNCTIONS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function toggleGPIO(esp,pin){
        const currentVal=gpioState[esp][pin]||false;
        const newVal=!currentVal;
        const num=pin.replace('gpio','');

        gpioState[esp][pin]=newVal;
        updateGPIOUI(esp,num,newVal);

        const path='/gpio/'+esp+'/'+pin;
        db.ref(path).set(newVal).then(()=>{
            showToast('success','‚úÖ '+esp.toUpperCase()+' GPIO '+num,newVal?'HIGH (ON)':'LOW (OFF)');
            gpioLog(esp+' GPIO '+num+' ‚Üí '+(newVal?'HIGH':'LOW'),'success');
        }).catch(e=>{
            showToast('error','‚ùå Failed',e.message);
            gpioLog('FAIL: '+e.message,'error');
            gpioState[esp][pin]=currentVal;
            updateGPIOUI(esp,num,currentVal);
        });
    }

    function setGPIOPWM(esp,pin,value){
        const num=pin.replace('gpio','');
        const pwmKey='pwm'+num;
        value=parseInt(value);

        document.getElementById('pwm-val-'+esp+'-'+num).textContent=value;
        gpioState[esp][pwmKey]=value;

        // Also update the toggle state
        const isOn=value>0;
        gpioState[esp][pin]=isOn;
        updateGPIOUI(esp,num,isOn);

        // Debounced write
        clearTimeout(window['_pwmTimer_'+esp+'_'+num]);
        window['_pwmTimer_'+esp+'_'+num]=setTimeout(()=>{
            db.ref('/gpio/'+esp+'/'+pwmKey).set(value);
            db.ref('/gpio/'+esp+'/'+pin).set(isOn);
            gpioLog(esp+' GPIO '+num+' PWM ‚Üí '+value,'success');
        },200);
    }

    function updateGPIOUI(esp,num,isOn){
        const toggle=document.getElementById('gpio-toggle-'+esp+'-'+num);
        const ind=document.getElementById('gpio-ind-'+esp+'-'+num);
        const state=document.getElementById('gpio-state-'+esp+'-'+num);
        if(toggle){isOn?toggle.classList.add('on'):toggle.classList.remove('on')}
        if(ind){ind.className='gpio-indicator '+(isOn?'on pulse':'off')}
        if(state){state.textContent=isOn?'ON':'OFF';state.className='gpio-state '+(isOn?'on':'off')}
    }

    function bulkGPIO(esp,state){
        const pins=esp==='esp1'?['gpio25','gpio26','gpio27','gpio13']:['gpio26','gpio25','gpio27'];
        const updates={};
        pins.forEach(pin=>{
            updates[pin]=state;
            gpioState[esp][pin]=state;
            updateGPIOUI(esp,pin.replace('gpio',''),state);
        });
        if(esp==='esp1'&&state){
            updates.pwm25=255;updates.pwm26=255;updates.pwm27=255;
            ['25','26','27'].forEach(n=>{
                const s=document.getElementById('pwm-esp1-'+n);if(s)s.value=255;
                const v=document.getElementById('pwm-val-esp1-'+n);if(v)v.textContent=255;
            });
        }else if(esp==='esp1'&&!state){
            updates.pwm25=0;updates.pwm26=0;updates.pwm27=0;
            ['25','26','27'].forEach(n=>{
                const s=document.getElementById('pwm-esp1-'+n);if(s)s.value=0;
                const v=document.getElementById('pwm-val-esp1-'+n);if(v)v.textContent=0;
            });
        }
        db.ref('/gpio/'+esp).update(updates).then(()=>{
            showToast('success','‚ö° '+esp.toUpperCase()+' ALL',state?'All GPIOs HIGH':'All GPIOs LOW');
            gpioLog(esp+' ALL ‚Üí '+(state?'HIGH':'LOW'),'success');
        });
    }

    function resetGPIO(esp){
        db.ref('/gpio/'+esp).remove().then(()=>{
            const pins=esp==='esp1'?['25','26','27','13']:['26','25','27'];
            pins.forEach(n=>{
                updateGPIOUI(esp,n,false);
                gpioState[esp]['gpio'+n]=false;
            });
            if(esp==='esp1'){['25','26','27'].forEach(n=>{
                const s=document.getElementById('pwm-esp1-'+n);if(s)s.value=0;
                const v=document.getElementById('pwm-val-esp1-'+n);if(v)v.textContent=0;
                gpioState.esp1['pwm'+n]=0;
            })}
            showToast('success','üîÑ Reset',''+esp.toUpperCase()+' GPIOs cleared ‚Äî back to auto');
            gpioLog(esp+' GPIO paths removed ‚Äî auto mode','success');
        });
    }

    function gpioLog(msg,type){
        const log=document.getElementById('gpioLog');
        const time=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});
        const line=document.createElement('div');line.className='cmd-line';
        line.innerHTML=`<span class="cmd-time">[${time}]</span> <span class="cmd-${type}">${msg}</span>`;
        log.appendChild(line);log.scrollTop=log.scrollHeight;
        if(log.children.length>50)log.removeChild(log.firstChild);
    }
    function clearGpioLog(){document.getElementById('gpioLog').innerHTML='<div class="cmd-line"><span class="cmd-info">Cleared</span></div>'}

    function copyESPCode(){
        const code=document.getElementById('espCodeBlock').textContent;
        navigator.clipboard.writeText(code).then(()=>showToast('success','üìã Copied','ESP32 GPIO code copied'));
    }

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  MAIN CONTROLS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function sendControl(key,value,msg,detail){
        logCmd('dashboard','SET /controls/'+key+'='+value,'info');
        db.ref('/controls/'+key).set(value).then(()=>{showToast('success',msg,detail);logCmd('firebase','OK','success')}).catch(e=>{showToast('error','‚ùå',e.message);logCmd('firebase','FAIL: '+e.message,'error')});
    }
    function toggleControl(key){
        const n=!controlState[key];
        const msgs={led:[n?'üí° ON':'üí° Auto',n?'Override LDR':'LDR resumes'],relay:[n?'üìÇ Open':'üìÅ Close','Relay '+(n?'HIGH':'LOW')],buzzer:[n?'üîî Alert!':'üîï Off','ESP32-2 LEDs']};
        sendControl(key,n,msgs[key][0],msgs[key][1]);
    }
    function resetAllControls(){
        db.ref('/controls').set({led:false,relay:false,buzzer:false}).then(()=>{showToast('success','üîÑ Reset','All auto');logCmd('firebase','All controls reset','success')});
    }
    function syncT(id,on){const el=document.getElementById(id);if(el){on?el.classList.add('on'):el.classList.remove('on')}}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  POTHOLE MAP
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let pinCount=0;
    db.ref('/potholes').orderByChild('timestamp').limitToLast(50).on('child_added',s=>{
        const d=s.val();if(!d)return;const key=s.key;pinCount++;
        document.getElementById('mapPinCount').textContent='üìç '+pinCount;
        const lat=d.lat||(currentGPS.lat+(Math.random()-.5)*.01);const lng=d.lng||(currentGPS.lng+(Math.random()-.5)*.01);
        const sev=d.severity==='critical'?'red':d.severity==='warning'?'orange':'yellow';
        const loc=d.location||(lat.toFixed(4)+','+lng.toFixed(4));const depth=(d.depth||0).toFixed(1);
        const popup=`<div style="font-family:Inter,sans-serif"><strong>${loc}</strong><br><span style="color:#86868b;font-size:12px">Depth:${depth}cm|${d.severity||'?'}</span><br><button onclick="markResolved('${key}')" style="padding:3px 8px;border-radius:8px;border:none;background:#34c759;color:#fff;font-size:11px;cursor:pointer;margin-top:4px">‚úÖ Resolve</button> <button onclick="deletePothole('${key}')" style="padding:3px 8px;border-radius:8px;border:none;background:#ff3b30;color:#fff;font-size:11px;cursor:pointer">üóëÔ∏è</button></div>`;
        if(mainMap){mapMarkers.push(L.marker([lat,lng],{icon:makeIcon(sev)}).addTo(mainMap).bindPopup(popup))}
        if(potholePageMap){pMapMarkers.push(L.marker([lat,lng],{icon:makeIcon(sev)}).addTo(potholePageMap).bindPopup(popup))}
        const dashList=document.getElementById('dashboardPotholeList'),allList=document.getElementById('allPotholeList');
        if(dashList&&dashList.querySelector('div[style*="text-align"]'))dashList.innerHTML='';if(allList&&allList.querySelector('div[style*="text-align"]'))allList.innerHTML='';
        const html=`<div class="pothole-severity ${d.severity||'minor'}"></div><div class="pothole-info"><h4>${loc} ${depth!=='0.0'?'‚Äî '+depth+'cm':''}</h4><span>${d.source==='sensor'?'ü§ñ':'üìù'} ${new Date((d.timestamp||0)*1000||Date.now()).toLocaleDateString()}</span></div><span class="pothole-status ${d.status||'pending'}">${d.status||'Pending'}</span>`;
        [dashList,allList].forEach(l=>{if(!l)return;const i=document.createElement('div');i.className='pothole-item';i.innerHTML=html;i.onclick=()=>{if(mainMap)mainMap.setView([lat,lng],17);switchPage('dashboard',document.querySelector('[data-page=dashboard]'))};l.insertBefore(i,l.firstChild);if(l===dashList&&l.children.length>8)l.removeChild(l.lastChild)});
    });
    function markResolved(k){db.ref('/potholes/'+k+'/status').set('resolved').then(()=>showToast('success','‚úÖ','Resolved'))}
    function deletePothole(k){if(confirm('Delete?'))db.ref('/potholes/'+k).remove().then(()=>showToast('info','üóëÔ∏è','Deleted'))}
    function centerMapOnGPS(){if(!currentGPS.fixed){showToast('warning','‚ö†Ô∏è','No GPS');return}mainMap.setView([currentGPS.lat,currentGPS.lng],16,{animate:true})}
    function fitAllMarkers(){if(!mapMarkers.length){showToast('warning','No markers','');return}mainMap.fitBounds(L.featureGroup(mapMarkers).getBounds().pad(.1))}
    function addPotholeAtCenter(){const c=mainMap.getCenter();document.getElementById('reportLat').value=c.lat.toFixed(6);document.getElementById('reportLng').value=c.lng.toFixed(6);openReportModal()}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  ALERTS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    let alertTs={};
    function addAlert(c,t,m){const n=Date.now();if(alertTs[t]&&n-alertTs[t]<10000)return;alertTs[t]=n;const l=document.getElementById('alertsList');if(l.children.length>15)l.removeChild(l.lastChild);const time=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});const i=document.createElement('div');i.className='alert-item';i.style.animation='fadeIn .4s';i.innerHTML=`<div class="alert-dot ${c}"></div><div class="alert-content"><h4>${t}</h4><p>${m}</p></div><span class="alert-time">${time}</span>`;l.insertBefore(i,l.firstChild);document.getElementById('notifDot').classList.add('show')}
    function clearAlerts(){document.getElementById('alertsList').innerHTML='<div class="alert-item"><div class="alert-dot green"></div><div class="alert-content"><h4>Cleared</h4><p>OK</p></div><span class="alert-time">Now</span></div>';alertTs={};document.getElementById('notifDot').classList.remove('show')}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  REPORT
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function submitReport(){const loc=document.getElementById('reportLocation').value.trim();const lat=parseFloat(document.getElementById('reportLat').value)||0;const lng=parseFloat(document.getElementById('reportLng').value)||0;if(!loc&&!lat){showToast('error','‚ùå','Enter location');return}const btn=document.getElementById('submitReportBtn');btn.disabled=true;btn.textContent='...';const dm={minor:3,warning:7,critical:15};db.ref('/potholes/manual_'+Date.now()).set({location:loc||lat.toFixed(4)+','+lng.toFixed(4),severity:document.getElementById('reportSeverity').value,size:document.getElementById('reportSize').value,description:document.getElementById('reportDesc').value,lat,lng,depth:dm[document.getElementById('reportSeverity').value]||5,timestamp:Math.floor(Date.now()/1000),status:'pending',source:'manual'}).then(()=>{closeReportModal();showToast('success','‚úÖ','Saved');document.getElementById('reportLocation').value='';document.getElementById('reportDesc').value='';btn.disabled=false;btn.textContent='Submit'}).catch(e=>{showToast('error','‚ùå',e.message);btn.disabled=false;btn.textContent='Submit'})}
    function useCurrentLocation(){if(currentGPS.fixed){document.getElementById('reportLat').value=currentGPS.lat.toFixed(6);document.getElementById('reportLng').value=currentGPS.lng.toFixed(6);showToast('success','üìç','ESP32 GPS used')}else if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{document.getElementById('reportLat').value=p.coords.latitude.toFixed(6);document.getElementById('reportLng').value=p.coords.longitude.toFixed(6);showToast('success','üìç','Browser GPS')},()=>showToast('error','‚ùå','No GPS'))}else showToast('error','‚ùå','No GPS')}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  SYSTEM STATUS
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateSystemStatus(){const b=document.getElementById('systemStatusBar'),d=document.getElementById('systemStatusDot'),t=document.getElementById('systemStatusText'),c=document.getElementById('connIndicator');if(esp1Online&&esp2Online){b.style.background='linear-gradient(135deg,#e8f5e9,#f1f8e9)';d.style.background='var(--accent-green)';t.textContent='‚úÖ Both ESP32s online';t.style.color='#2d6a2e';c.className='conn-indicator online';c.textContent='üü¢ Online'}else if(esp1Online||esp2Online){b.style.background='linear-gradient(135deg,#fff3e0,#fef9e7)';d.style.background='var(--accent-orange)';t.textContent='‚ö†Ô∏è '+(esp1Online?'ESP1':'ESP2')+' only';t.style.color='#e65100';c.className='conn-indicator partial';c.textContent='üü° Partial'}else{b.style.background='linear-gradient(135deg,#fce4ec,#fff3e0)';d.style.background='var(--accent-red)';t.textContent='‚ùå Both offline';t.style.color='#c62828';c.className='conn-indicator offline';c.textContent='üî¥ Offline'}}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  TERMINAL ‚Äî now supports gpio commands
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function logCmd(s,m,t){const l=document.getElementById('commandLog');const time=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'});const line=document.createElement('div');line.className='cmd-line';line.innerHTML=`<span class="cmd-time">[${time}]</span> <span class="cmd-${t}">[${s}]</span> ${m}`;l.appendChild(line);l.scrollTop=l.scrollHeight;if(l.children.length>100)l.removeChild(l.firstChild)}
    function executeCommand(){
        const input=document.getElementById('terminalInput');const cmd=input.value.trim().toLowerCase();if(!cmd)return;input.value='';logCmd('you',cmd,'info');
        // GPIO commands: gpio esp1 25 on, gpio esp2 26 off, gpio esp1 25 pwm 128
        const gpioMatch=cmd.match(/^gpio\s+(esp[12])\s+(\d+)\s+(on|off|high|low)$/);
        const pwmMatch=cmd.match(/^gpio\s+(esp[12])\s+(\d+)\s+pwm\s+(\d+)$/);
        if(gpioMatch){
            const [_,esp,pin,state]=gpioMatch;const val=state==='on'||state==='high';
            db.ref('/gpio/'+esp+'/gpio'+pin).set(val).then(()=>{logCmd('sys','‚Üí /gpio/'+esp+'/gpio'+pin+' = '+val,'success');updateGPIOUI(esp,pin,val)});return;
        }
        if(pwmMatch){
            const [_,esp,pin,val]=pwmMatch;const v=Math.min(255,Math.max(0,parseInt(val)));
            db.ref('/gpio/'+esp+'/pwm'+pin).set(v).then(()=>{logCmd('sys','‚Üí /gpio/'+esp+'/pwm'+pin+' = '+v,'success')});
            db.ref('/gpio/'+esp+'/gpio'+pin).set(v>0);return;
        }
        const cmds={
            'led on':()=>{sendControl('led',true,'üí° ON','');return'‚Üí /controls/led=true'},'led off':()=>{sendControl('led',false,'üí° Auto','');return'‚Üí /controls/led=false'},
            'relay on':()=>{sendControl('relay',true,'üìÇ','');return'‚Üí /controls/relay=true'},'relay off':()=>{sendControl('relay',false,'üìÅ','');return'‚Üí /controls/relay=false'},
            'buzzer on':()=>{sendControl('buzzer',true,'üîî','');return'‚Üí /controls/buzzer=true'},'buzzer off':()=>{sendControl('buzzer',false,'üîï','');return'‚Üí /controls/buzzer=false'},
            'status':()=>`ESP1:${esp1Online?'üü¢':'üî¥'} ESP2:${esp2Online?'üü¢':'üî¥'} LED:${controlState.led} RELAY:${controlState.relay} BUZZER:${controlState.buzzer}`,
            'reset':()=>{resetAllControls();return'Reset all'},'help':()=>'led on/off, relay on/off, buzzer on/off, gpio esp1 25 on/off, gpio esp1 25 pwm 128, status, reset',
            'clear':()=>{clearCommandLog();return'Cleared'},
        };
        const h=cmds[cmd];if(h){logCmd('sys',h(),'success')}else logCmd('sys','Unknown: "'+cmd+'". Type help','error');
    }
    function runQuickCmd(c){document.getElementById('terminalInput').value=c;executeCommand()}
    function clearCommandLog(){document.getElementById('commandLog').innerHTML='<div class="cmd-line"><span class="cmd-info">Cleared</span></div>'}

    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    //  UI
    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
    function updateTime(){const el=document.getElementById('liveTime');if(el)el.textContent=new Date().toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}
    setInterval(updateTime,1000);updateTime();
    function toggleSidebar(){document.getElementById('sidebar').classList.toggle('open');document.getElementById('sidebarOverlay').classList.toggle('show')}
    const pageTitles={dashboard:['Dashboard','Live data from ESP32-1 & ESP32-2'],potholes:['Potholes','Map + reports'],devices:['Devices','ESP32 status'],lighting:['Street Lights','LDR auto-control'],water:['Water Supply','Float sensor'],waste:['Waste Management','Dustbin + gas'],misc:['Misc / GPIO Control','Individual pin ON/OFF for every GPIO'],terminal:['Terminal','Direct Firebase writes']};
    function switchPage(p,n){document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));if(n)n.classList.add('active');document.querySelectorAll('.page').forEach(i=>i.classList.remove('active'));const el=document.getElementById('page-'+p);if(el)el.classList.add('active');if(pageTitles[p]){document.getElementById('pageTitle').textContent=pageTitles[p][0];document.getElementById('pageSubtitle').textContent=pageTitles[p][1]}document.getElementById('sidebar').classList.remove('open');document.getElementById('sidebarOverlay').classList.remove('show');setTimeout(()=>{if(mainMap)mainMap.invalidateSize();if(potholePageMap)potholePageMap.invalidateSize()},300)}
    function openReportModal(){document.getElementById('reportModal').classList.add('show');if(currentGPS.fixed){document.getElementById('reportLat').value=currentGPS.lat.toFixed(6);document.getElementById('reportLng').value=currentGPS.lng.toFixed(6)}initModalMap()}
    function closeReportModal(){document.getElementById('reportModal').classList.remove('show')}
    document.getElementById('reportModal').addEventListener('click',function(e){if(e.target===this)closeReportModal()});
    document.addEventListener('keydown',e=>{if(e.key==='Escape')closeReportModal()});

    let toastN=0;
    function showToast(type,title,msg){const c=document.getElementById('toastContainer');const id='t'+(++toastN);const icons={success:'<path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/>',error:'<path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/>',info:'<path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"/>',warning:'<path d="M1 21h22L12 2 1 21zm12-3h-2v-2h2v2zm0-4h-2v-4h2v4z"/>'};const t=document.createElement('div');t.className='toast';t.id=id;t.innerHTML=`<div class="toast-icon ${type}"><svg viewBox="0 0 24 24">${icons[type]||icons.info}</svg></div><div class="toast-text"><h4>${title}</h4><p>${msg||''}</p></div><button class="toast-close" onclick="dismissToast('${id}')"><svg viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg></button>`;c.appendChild(t);requestAnimationFrame(()=>t.classList.add('show'));setTimeout(()=>dismissToast(id),4000);while(c.children.length>4)c.removeChild(c.firstChild)}
    function dismissToast(id){const t=document.getElementById(id);if(t){t.classList.remove('show');setTimeout(()=>t.remove(),500)}}

    // INIT
    document.addEventListener('DOMContentLoaded',()=>{initMaps();logCmd('boot','SmartVillage v3.0 with GPIO control','success');logCmd('boot','GPIO paths: /gpio/esp1/gpio25..27,13  /gpio/esp2/gpio25..27','info')});
    if(navigator.geolocation){navigator.geolocation.getCurrentPosition(p=>{if(!currentGPS.fixed){currentGPS.lat=p.coords.latitude;currentGPS.lng=p.coords.longitude;if(mainMap)mainMap.setView([currentGPS.lat,currentGPS.lng],14);if(potholePageMap)potholePageMap.setView([currentGPS.lat,currentGPS.lng],14)}},()=>{},{enableHighAccuracy:false,timeout:5000})}
    </script>
</body>
</html>
